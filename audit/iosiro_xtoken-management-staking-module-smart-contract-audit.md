# xToken Management Staking Module Smart Contract Audit

#### xToken, 13 July 2021

# 1. Introduction

iosiro was commissioned by [xToken](https://xtoken.market/) to conduct an audit of their xToken Management staking module smart contracts. The audit was performed by 1 auditor between 8 July and 12 July, consuming a total of 3 resource days.

This report is organized into the following sections.

- **[Section 2 - Executive Summary:](#section-2)** A high-level description of the findings of the audit.
- **[Section 3 - Audit Details:](#section-3)** A description of the scope and methodology of the audit.
- **[Section 4 - Design Specification:](#section-4)** An outline of the intended functionality of the smart contracts.
- **[Section 5 - Detailed Findings:](#section-5)** Detailed descriptions of the findings of the audit.

The information in this report should be used to better understand the risk exposure of the smart contracts, and as a guide to improving the security posture of the smart contracts by remediating issues identified. The results of this audit are only a reflection of the source code reviewed at the time of the audit and of the source code that was determined to be in-scope.

The purpose of this audit was to achieve the following:

- Identify potential security flaws.
- Ensure that the smart contracts functioned according to the documentation provided.

Assessing the economics, game theory, or underlying business model of the platform were strictly beyond the scope of this audit.

Due to the unregulated nature and ease of transfer of cryptocurrencies, operations that store or interact with these assets are considered very high risk with regards to cyber attacks. As such, the highest level of security should be observed when interacting with these assets. This requires a forward-thinking approach, which takes into account the new and experimental nature of blockchain technologies. Strategies that should be used to encourage secure code development include:

- Security should be integrated into the development lifecycle and the level of perceived security should not be limited to a single code audit.
- Defensive programming should be employed to account for unforeseen circumstances.
- Current best practices should be followed where possible.

<a name="section-2"></a>

# 2. Executive Summary

This report presents the findings of the audit performed by iosiro on the smart contract implementation of the xToken Management staking module, [xtoken-mgmt-staking](https://github.com/xtokenmarket/xtoken-mgmt-staking). This module allows users to stake their XTK tokens to receive XTK rewards from fees generated by xToken xAssets and a portion of the XTK supply.

#### Audit Findings

iosiro noted one medium risk issue and two informational issues. The medium risk issue related to a possible theft-of-yield vulnerability allowing users to steal a portion of the XTK rewards in certain conditions. The informational issues related to minor rounding errors and design considerations, including storage improvements and additional validation. No issues remained open at the end of the assessment.

Overall, the code was found to be of a high standard and primarily followed best practices.

#### Recommendations

At a high level, the security posture of the xToken Management staking module could be further strengthened by:

- Ensuring that integration with existing xAssets, such as the `RevenueController` fee withdrawal, are performed correctly.
- Performing additional audits at regular intervals, as security best practices, tools, and knowledge change over time. Additional audits over the course of the project's lifespan ensure the longevity of the codebase.
- Implementing a bug bounty program to encourage the responsible disclosure of security vulnerabilities in the smart contracts.

<a name="section-3"></a>

# 3. Audit Details

## 3.1 Scope

The source code considered in-scope for the assessment is described below. Code from all other files is considered to be out-of-scope. Out-of-scope code that interacts with in-scope code is assumed to function as intended and introduce no functional or security vulnerabilities for the purposes of this audit.

### 3.1.1 xToken Management Staking

**Project Name:** xtoken-mgmt-staking
<br/>
**Commit:** [ecbd3b9](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/ecbd3b98017395162ac5e102722e9193bbf9fb8c)<br/>
**File(s):** XTKManagementStakingModule.sol, RewardController.sol, RevenueController.sol

## 3.2 Methodology

A variety of techniques were used while conducting the audit. These techniques are briefly described below.

### 3.2.1 Code Review

The source code was manually inspected to identify potential security flaws. Code review is a useful approach for detecting security flaws, discrepancies between the specification and implementation, design improvements, and high risk areas of the system.

### 3.2.2 Dynamic Analysis

The contracts were compiled, deployed, and tested in a Ganache test environment. Manual analysis was used to confirm that the code operated at a functional level, and to verify the exploitability of any potential security issues identified.

### 3.2.3 Automated Analysis

Tools were used to automatically detect the presence of several types of security vulnerabilities, including reentrancy, timestamp dependency bugs, and transaction-ordering dependency bugs. The static analysis results were manually analysed to remove false positive results. True positive results would be indicated in this report. Static analysis tools commonly used include Slither, MythX, as well as Securify. Furthermore, the Remix IDE, compilation output, and linters are also used to identify potential areas of concern.

## 3.3 Risk Ratings

Each issue identified during the audit has been assigned a risk rating. The rating is determined based on the criteria outlined below.

- **High Risk** - The issue could result in a loss of funds for the contract owner or system users.
- **Medium Risk** - The issue resulted in the code specification being implemented incorrectly.
- **Low Risk** - A best practice or design issue that could affect the security of the contract.
- **Informational** - A lapse in best practice or a suboptimal design pattern that has a minimal risk of affecting the security of the contract.
- **Closed** - The issue was identified during the audit and has since been addressed to a satisfactory level to remove the risk that it posed.

<a name="section-4"></a>

# 4. Design Specification

The following section outlines the intended functionality of the system at a high level.

## 4.1 xToken Management Staking

xToken Management is a staking module available for XTK holders to stake their tokens and earn a proportional share of fees generated by xAssets, as well as a share of XTK token rewards.

xAssets, such as xAave and xSNX, earn fees from mint, burn and claim events in a variety of tokens. These xAssets will be modified to include functionality to allow a `RevenueController` module to withdraw these fees. The fees will then be swapped into XTK and transferred to the xToken Management staking module, to be distributed among XTK holders.

Another module, the `RewardController` contract, will be allocated a portion of the XTK supply to be distributed to the xToken Management staking module over a certain period. The exact period and portion of the supply is determined by the contract owners. The release mechanism is not access-controlled, and can be called by any user when rewards are available.

<a name="section-5"></a>

# 5. Detailed Findings

The following section includes in depth descriptions of the findings of the audit.

## 5.1 High Risk

No high risk issues were present at the conclusion of the audit.

## 5.2 Medium Risk

No high risk issues were present at the conclusion of the audit.

## 5.3 Low Risk

No low risk issues were present at the conclusion of the audit.

## 5.4 Informational

No informational items were present at the conclusion of the audit.

## 5.5 Closed

### 5.5.1 Theft of yield at 0% penalty (Medium risk)

_[RewardController.sol#L78](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RewardController.sol#L78)_

The `rewardController` contract exposed a `releaseReward()` function without access-control, allowing any user to perform the transfer of available XTK rewards to the `XTKManagementStakingModule` contract. If the unstake penalty was set to 0%, users would be able to steal a portion of the available rewards by staking XTK before releasing the reward, and unstaking the initial XTK amount thereafter. XTK liquidity could be borrowed (e.g. through flash loans or flash swaps) to increase the proportion of staked XTK, to receive a higher proportion of rewards.

#### Recommendation

Theft of yield can be prevented by ensuring that the unstake penalty is at a substantial level to make it expensive to unstake large XTK deposits over a short period, or by implementing a minimum staking period. Implementing a minimum staking period will need to include additional overhead, such as keeping track of user deposits and ensuring that xXTK can't be exchanged through a secondary market.

##### Update

The team indicated that the unstake penalty was likely to start at 1.75% and then gradually be reduced to some floor, likely around 0.25%. The contract was also updated to prevent a 0% unstake penalty on [XTKManagementStakingModule.sol#L73](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/bf9dfa55821c351698ac8df4ed0170f2e882c727#diff-8c108301e2c990dda38b833191005a918654b3a6be4fe1898667a11ea5c3cb95R73).

### 5.5.2 Minor rounding errors (Informational)

_[XTKManagementStakingModule.sol#L105](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/XTKManagementStakingModule.sol#L105), [RewardController.sol#L58](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RewardController.sol#L58)_

The `xtkToDistribute` amount calculated in `XTKManagementStakingModule.unstake()` was subject to slight rounding errors. This was due to a multiplication that happens in `calculateXtkToDistributeOnUnstake()` after a division in `calculateProRataXtk()`. When testing, the rounding errors were minimal, resulting in up to 1 wei difference.

Similarly, the `rewardRate` amount as calculated in `RewardController.initRewardDurationAndAmount()` is multiplied with the `lastTimeRewardApplicable() - lastUpdateTime` amount in `RewardController.releaseReward()`. As a second multiplication happens after a division, it opened up the possibility for slight rounding errors to occur when releasing the reward.

#### Recommendation

The `xtkToDistribute` amount could be calculated as `(xxtkAmount * xtkBalance * unstakePenalty) / (totalSupply() * DEC_18)`, avoiding a multiplication after a division.

As the `rewardRate` is calculated in the access-controlled function `initRewardDurationAndAmount()`, it is up to the owner to use `_rewardDuration` and `_rewardPeriodAmount` amounts that are cleanly divisible to avoid rounding errors.

##### Update

Validation was added to ensure that the `_rewardPeriodAmount` was a multiple of the `_rewardDuration` in [e241f45](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/e241f458aaaa406772194255c155bb4e45305d35#diff-473de90b9af8283633bd14afcf442f4be161441ee904253bd62f957fb2a94d07R55).

As the rounding errors affecting the `xtkToDistribute` quantity was minimal, the team decided to leave the code unchanged as further adjustments would decrease code readability.

### 5.5.3 Design comments (Informational)

Actions to improve the functionality and readability of the codebase are outlined below.

#### Storage considerations

_[XTKManagementStakingModule.sol#L40](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/XTKManagementStakingModule.sol#L40), [RevenueController.sol#L68](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RevenueController.sol#L68), [RewardController.sol#L46](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RewardController.sol#L46)_

The initializer functions of all three in-scope contracts was used to set the address of the `xtk` state variable, which would remain constant throughout the lifetime of the contract. Therefore the state variable should be marked as `immutable` and initialized in the constructor. Immutable state variables save storage slots, which in turn reduce gas fees.

Further reading on immutables can be [found here](https://blog.soliditylang.org/2020/05/13/immutable-keyword/).

##### Update

The `xtk` address was made constant in [44e81e7](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/44e81e77d2feb2a9ecfc85fe9ba5b7e0ab483711).

#### Missing return validation

_[XTKManagementStakingModule.sol#L91](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/XTKManagementStakingModule.sol#L91), [XTKManagementStakingModule.sol#L109](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/XTKManagementStakingModule.sol#L109), [RevenueController.sol#L102](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RevenueController.sol#L102), [RevenueController.sol#L122](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RevenueController.sol#L122), [RewardController.sol#L83](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RewardController.sol#L83)_

The return of XTK transfer and transferFrom calls were not validated. While the XTK token reverted on attempting to `transfer` or `transferFrom` with or from an account with an insufficient balance or allowance, other tokens return false instead of reverting, allowing the execution to continue. We therefore recommend to wrap all ERC20 transfer and transferFrom calls in `require` statements or use the SafeERC20 library out of best practice.

##### Update

The code was refactored to make use of the SafeERC20 library in [18710f7](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/18710f7e73e23d5a16cd9a56fadce00dab7dc7ba).

#### Fix spelling and grammar errors

Spelling and grammar mistakes were identified in the codebase. Fixing these mistakes can help improve the end-user experience by providing clear information on errors encountered, and improve the maintainability and auditability of the codebase.

- [RevenueController.sol#L80](https://github.com/xtokenmarket/xtoken-mgmt-staking/blob/ecbd3b98017395162ac5e102722e9193bbf9fb8c/contracts/RevenueController.sol#L80): "genented" in the comment should be "generated".

##### Update

Fixed in [e241f45](https://github.com/xtokenmarket/xtoken-mgmt-staking/commit/e241f458aaaa406772194255c155bb4e45305d35#diff-7a8cbc4c40e5288760451d995c921c71b374b9f2510293cfaa16b3ce2d0712d6R76).
